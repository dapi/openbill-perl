КАК ЭТО ВСЕ РАБОТАЕТ

По крайней мере как должно работать.

В кроне есть 4 строки:

30 5 * * * utils/append_day_stats.sh `date -d "1 day ago 00:00" %Y-%m`
и
00 6 * * * utils/send_mail_report.sh day reports-daily@lists.orionet.ru
05 6 * * 1 utils/send_mail_report.sh week reports-weekly@lists.orionet.ru
05 6 1 * * utils/send_mail_report.sh month reports-weekly@lists.orionet.ru

Первой запускается utils/append_day_stats.sh, который:
1. Считывает из биллинга список существующих хостов с их тарифами
2. Формирует входной файл для reporter'а (делит хосты на группы по тарифу)
3. Запускает reporter, который пересчитывает всю статистику за последний день
по логам из /mnt/stats/history, и групп хостов 
4. Обработанный файл с кол-вом принятых/отправленных байт за каждый час 
и по каждой группе дописывает в /mnt/stats/bandwidth_usage/stats-номер_месяца.txt
Этот файл используется для формирования отчетов.

Три другие строки занимаются тем, что по файлам /mnt/stats/bandwidth_usage/* 
рисуют таблицы загрузки канала и отправляют их в списки рассылки.


О REPORTER'е

   Программа пересчитывает трафие пользователей. 
Она использует логи статистики ipacctd'а из /mnt/stats/history.
Пр-а выводит статистику по каждой группе ип адресов
(кол-во ГБ переданных каждой группой ип адресов за каждый час и % от возможного
трафика при канале x мегабит).

Параметры:
-1 - Вывести статистику за каждый час
-2 - Вывести среднюю статистику загрузке в будни и выходные
-3 - Вывести неформатированную статистику (в формате для обработки скриптом getstats.awk)
-с file - конфиг с группами ип адресов (- - stdin)
-f file - файл с логами ipacctd ( - - stdin)
-m mb - жирина канала в мегабитах (по умолчанию 4)

Временной диапазон в логе может быть максиум 1 месяц (а точнее 31*24час).

КОНФИГ
Каждая строка может иметь один и з форматов:
#коммментарий
Группы имя
Группа ип[/маска]

Пример:
#1 группа - ввв и почта
1 ВВВ ПОЧТА
1 77.240.152.34
1 77.240.152.36
#2 - локальые адреса
2 ЛОКАЛЬНЫЕ
2 10.100.0.0/16
2 10.100.0.0/16
2 77.240.152.0/24
#3 - еще что-то
3 ЕЩЕ ЧТО-то
3 10.100.1.1


ЗАМЕЧАНИЯ

   Если ип адрес попадает под несколько групп (в примере 77.240.152.34 попадает в
группы 1 и 2 а 10.100.1.1 в 2 и 3), группа будет определятся по наиболее полному
определенному адресу, т.е. по наибольшей маске (77.240.152.34 будет в 1 группе, у
него маска 32, а 10.100.1.1 - в 3). Подробновти в route(8).

   Начальная дата определеятеся по первой записи лога, и дальнейшем в логе время
ранее чем эта запись не должно быть.

   В stder программа выводит все сообщени об ошибках, а также локальный трафик
(т.е. трафик между ип адресами src_ip и dst_ip которые есть в конфиге) и
неизвестный трафик (если ни src_ip, ни dst_ip нет в конфиге). Локальный трафик
не учитывается при подсчете часовой загрузки.

   Направление трафика определяется по группе из конфиг файла.
Если src_ip в конфиге, а dst_ip - нет, считаем что трафик исходящий (от клиента)
Если dst_ip в конфиге, а src_ip - нет, считаем что трафик входящий (к клиенту)
Если и src_ip и dst_ip в конфиге, трафик локальный, его не счтиаем, выводим в
stderr
Если ни src_ip, ни dst_ip нет, его тоже не считаем, выводим в stderr.

   В contrib есть кучка скриптов для празличных преобразований и обработки
статистики.

   Как будет считаться трафик в ночь перевода на летнее-зимнее время и при
добавлении секунд в новогоднюю ночь, неизвестно :)

   Статистика по трафику почему-то очень сильно расходится с логами загрузки 
канала по cacti. В cacti как входящий, так исходящий трафик обычно на 80-100
МБ в час больше.

