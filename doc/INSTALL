Установить:

Date::Handler::Russian

1) Распаковка дистрибутива:


        tar -yxf openbill-??.tar.bz2

        cd ./openbill/

        perl  Makefile.PL

        make
        su
        make install


2) Создание базы в mysql


        <  doc/mysql.sql

Создать пользователя в mysql для базы (заменить secret на свой пароль)

        GRANT select, insert, update, delete, lock tables
        ON openbill.* TO openbill@localhost
        IDENTIFIED BY 'secret';


изменить этот пароль в utils/mysql.sh и etc/local.xml

3) Читать doc/CHANGES

3) Создание служб, привратников и коллекторов.

   # Создание привратника (модуль, отвечающий за включение/выключение абонента)

   > create_janitor
   Название: iptable
   Модуль: openbill::Janitor::IPTables
   Коментарий *:

   > create_service
   Создание нового сервиса:
   Название: iptraff
   Модуль: openbill::Service::IPTraff
   Коментарий *:
   Создан сервис #1

   > create_collector
   Создание коллектора:
   Название: trafd
   Модуль: openbill::Collector::Trafd
   Служба: iptraff
   Коментарий *:
   Создан коллектор #1

4) Создать тарифы для установленных служб:

   > create_tariff
   Создание новой улицы:
   Тариф: Тестовый
   Скрытый: нет
   Абонплата: 2000
   Бесплатный трафик (Мб) *: 1000
   Стоимость 1Мб: 2
   Стоимость 1Мб почты *: 1.5
   Стоимость 1Мб локальный *: 0
   Служба: iptraff
   Коментарий *:
   Создана улица #18


5) Создание географии. Необходимо сначала создать все улицы и дома,
   в которых будут устанавливаться роутеры, хости и регистрироваться
   абоненты.


   > create_street

   > create_building



6) Создать роутеры:

   > create_router
   Создание нового роутера:
   IP: 10.100.2.1
   Реальный IP: 217.107.177.162
   Имя хоста: bridge2
   Короткое имя хоста: bridge2
   Улица: ул. Водопроводная
   Дом: 20
   Квартира/Офис: чердак 7-го подъезда
   Привратник: 1        # номер привратника
   Использовать привратник: да
   Действующий роутер: да
   Коментарий *:
   Создан роутер #1

Создаём на роутере папку /usr/local/openbill/router и копируем туда целиком папку ./router/

   Помечаем какие коллектором будет пользоваться данный роутер и по
   каким интерфейсам не учитывать статистику:

   mysql> insert into router_collector values (номер_роутера(1),номер_коллектора(1),1,NULL,NULL,'eth0(интерфейс который исключить)');
   # интерфейсы для исключения можно указывать через запятую


   Определение локального трафика и абонентских хостов. Таблица router_ip.

   mysql> insert into router_ip values (номер_роутера,маска,биты,тип,коментарий);

   маска - ip адрес сдвинутый на маску в виде числа. Например сеть
   192.168.1.0/24 вставляется так (1,inet_aton('0.192.168.1'),8,NULL,NULL,'')

   Если bits=0, и маска
   1 - то используется ip-адрес роутера
   2 - то используется real_ip-адрес роутера
   3 - то используются ip адреса всех роутеров
   4 - то используются real_ip адреса всех роутеров
   5 - ip-адреса всех хостов


   ПРИМЕР.

   Роутер имет адреса 10.100.2.1 и 217.107.177.162.

   Абоненты имеют адреса 10.100.2.0/24.

   Локальным считается трафик на сети 10.100.0.0/16 и 192.168.0.0/16,
   на все адреса роутера (10.100.2.1 и 217.107.177.162) и централный
   сервер 217.107.177.196 (colocation).

   Данная конфигурация создайтся следующим образом:

   # клиентская сеть
   insert into router_ip values (1,inet_aton('0.10.100.2'),8,'client',NULL);

   # трафик роутер-интернет тоже будет считаться, чтобы он правильно
   # определялся, мы прописываем адреса роутара как клиентские
   # (прописываем таким способом, чтобы не выписывать туда
   # фиксированные адреса роутеров типа: inet_aton('10.100.2.1'),0)

   insert into router_ip values (1,1,0,'client',NULL);
   insert into router_ip values (1,2,0,'client',NULL);


   # локальные адреса
   insert into router_ip values (1,inet_aton('0.0.10.100'),16,'local',NULL);
   insert into router_ip values (1,inet_aton('0.0.192.168'),16,'local',NULL);
   insert into router_ip values (1,inet_aton('10.100.2.1'),0,'local',NULL);      # первый адрес роутера
   insert into router_ip values (1,inet_aton('217.107.177.162'),0,'local',NULL); # второй адрес роутера
   insert into router_ip values (1,inet_aton('217.107.177.196'),0,'local',NULL); # colocation



  obs> make_router_sshkey НОМЕР_РОУТЕРА

   затем ввести рутовый пароль на роутере


4) Создать правила доступа (iptables) для хостов:

./utils/create_host_am.pl

Правила можно подредактировать сразу в этом файле.



5) Регистрация хоста и клиента:

   > create_host
   Создание нового хоста:
   Хост или сеть: 10.100.2.10
   MAC *: 00:00:00:00:00:00
   hostname: client1
   Тип подключения: common
   Включение: deactive      # по-умолчанию ставим deactive, active поставится само при активации клиента
   Улица: ул. Водопроводная
   Дом: 20
   Квартира/Офис: 98
   Роутер: bridge2   # короткое имя роутера
   Привратник *: 1   # номер привратника
   Коментарий *:
   Создан хост НОМЕР

   > create_client

   > attach_host host_id=.. client_id=..

   > change_tariff tariff=.. client=..

   > activate_client НОМЕР

   > update_janitors



6) Сбор статистики


   > collect

   > update_traffic

   > charge
